---
import type { ArticleData } from '../../types';
import Tag from '../ui/Tag.astro';
import DateBadge from '../ui/DateBadge.astro';

export interface Props extends Omit<ArticleData, 'content'> {
  compact?: boolean;
  eager?: boolean;
  fromPage?: number;
}

const { 
  title, 
  description, 
  image, 
  tags, 
  date, 
  slug, 
  compact = false, 
  eager = false, 
  fromPage 
} = Astro.props;

// 記事リンクにページ番号パラメータを追加
const articleUrl = fromPage ? `/blog/${slug}/?from=${fromPage}` : `/blog/${slug}/`;

// 表示するタグ数の制限
const displayTags = compact ? tags.slice(0, 2) : tags;
---

{compact ? (
  <!-- Compact layout for homepage -->
  <article class="group h-full">
    <a 
      href={articleUrl} 
      class="block h-full rounded-lg hover:bg-gray-50 dark:hover:bg-white/5 transition-colors duration-300"
      aria-label={`記事「${title}」を読む`}
      tabindex="0"
    >
      <div class="flex gap-4 items-center h-full p-2">
        <!-- 記事画像 -->
        <div class="flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden bg-gray-200 dark:bg-white/5">
          <img 
            src={image} 
            alt={title}
            class="w-full h-full object-cover"
            loading={eager ? "eager" : "lazy"}
          />
        </div>
        
        <!-- 記事情報 -->
        <div class="flex-1 min-w-0 py-1">
          <!-- 日付バッジ -->
          <DateBadge 
            date={date} 
            variant="compact"
            class="mb-1.5 text-retro-red dark:text-retro-red font-bold"
          />
          
          <!-- タイトル -->
          <h2 class="text-sm font-bold text-gray-900 dark:text-retro-text mb-1.5 line-clamp-2 group-hover:text-retro-green dark:group-hover:text-retro-green-hover transition-colors duration-200">
            {title}
          </h2>
          
          <!-- タグ -->
          <div class="flex flex-wrap gap-1.5">
            {displayTags.map((tag) => (
              <Tag
                tag={tag}
                variant="default"
                size="sm"
                interactive={false}
              />
            ))}
          </div>
        </div>
      </div>
    </a>
  </article>
) : (
  <!-- Grid layout: 雑誌見出し風 -->
  <article class="group h-full flex flex-col">
    <a 
      href={articleUrl} 
      class="block flex-1 flex flex-col group"
      aria-label={`記事「${title}」を読む`}
      tabindex="0"
    >
      <!-- 記事画像：枠線なし、角丸だけ少しつける -->
      <div class="aspect-[3/2] max-h-48 overflow-hidden rounded-2xl bg-gray-100 dark:bg-white/5 mb-4 ring-1 ring-black/5 dark:ring-white/10">
        <img 
          src={image} 
          alt={title}
          class="w-full h-full object-cover transition-opacity duration-300 group-hover:opacity-90"
          loading={eager ? "eager" : "lazy"}
        />
      </div>
      
      <!-- 記事情報：パディングなし -->
      <div class="flex flex-col flex-1 px-1">
        <!-- メタ情報 -->
        <div class="flex items-center justify-between mb-2">
          <DateBadge 
            date={date} 
            variant="default"
            showIcon={false}
            class="!bg-transparent border border-retro-red/50 text-retro-red dark:text-retro-red font-bold px-2 py-0.5 rounded-full text-xs"
          />
        </div>
        
        <!-- タイトル：少し大きくしてメリハリを -->
        <h2 class="text-xl font-bold text-gray-900 dark:text-retro-text mb-3 group-hover:text-retro-green dark:group-hover:text-retro-green-hover transition-colors duration-200 line-clamp-2 leading-tight">
          {title}
        </h2>
        
        <!-- タグ -->
        <div class="mt-auto pt-1 flex flex-wrap gap-x-3 gap-y-1">
          {displayTags.map((tag) => (
            <Tag
              tag={tag}
              variant="default"
              size="sm"
              interactive={false}
              class="!bg-transparent text-gray-500 dark:text-gray-400 font-medium text-xs px-0"
            />
          ))}
        </div>
      </div>
    </a>
  </article>
)}

<style>
  /* テキストの行制限 */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* キーボードナビゲーション時のみフォーカス表示 */
  article:has(a:focus-visible) {
    outline: 2px solid #477A72;
    outline-offset: 2px;
    border-radius: 12px;
  }
  
  /* リンクのデフォルトフォーカス枠を非表示 */
  a:focus {
    outline: none;
  }
  
  /* 内部要素のフォーカスを防ぐ */
  a * {
    pointer-events: none;
    user-select: none;
  }
  
  /* aタグ自体はクリック可能にする */
  a {
    pointer-events: auto;
  }
</style>